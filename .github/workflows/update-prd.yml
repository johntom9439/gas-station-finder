name: Update PRD in Google Docs

on:
  push:
    branches:
      - main
    paths:
      - 'PRODUCT_REQUIREMENTS.md'

jobs:
  update-google-docs:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: |
          pip install google-auth google-auth-oauthlib google-auth-httplib2 google-api-python-client

      - name: Update Google Docs
        env:
          GOOGLE_SERVICE_ACCOUNT_KEY: ${{ secrets.GOOGLE_SERVICE_ACCOUNT_KEY }}
          GOOGLE_DOCS_ID: ${{ secrets.GOOGLE_DOCS_ID }}
        run: |
          python3 << 'EOF'
          import os
          import json
          import re
          from google.oauth2 import service_account
          from googleapiclient.discovery import build

          # Service Account ì¸ì¦
          credentials_dict = json.loads(os.environ['GOOGLE_SERVICE_ACCOUNT_KEY'])
          credentials = service_account.Credentials.from_service_account_info(
              credentials_dict,
              scopes=['https://www.googleapis.com/auth/documents']
          )

          # Google Docs API í´ë¼ì´ì–¸íŠ¸
          service = build('docs', 'v1', credentials=credentials)
          document_id = os.environ['GOOGLE_DOCS_ID']

          # PRODUCT_REQUIREMENTS.md ì½ê¸°
          with open('PRODUCT_REQUIREMENTS.md', 'r', encoding='utf-8') as f:
              markdown_content = f.read()

          # ê¸°ì¡´ ë¬¸ì„œ ë‚´ìš© ì‚­ì œ
          document = service.documents().get(documentId=document_id).execute()
          doc_content = document.get('body').get('content')
          end_index = 1
          if len(doc_content) > 1:
              last_element = doc_content[-1]
              if 'endIndex' in last_element:
                  end_index = last_element['endIndex'] - 1

          requests = []
          if end_index > 1:
              requests.append({
                  'deleteContentRange': {
                      'range': {'startIndex': 1, 'endIndex': end_index}
                  }
              })

          # ë§ˆí¬ë‹¤ìš´ì„ íŒŒì‹±í•˜ì—¬ êµ¬ì¡°í™”ëœ ë°ì´í„°ë¡œ ë³€í™˜
          lines = markdown_content.split('\n')
          elements = []  # (type, text, level)

          for line in lines:
              if not line.strip():
                  elements.append(('empty', '', 0))
              elif line.startswith('### '):
                  elements.append(('heading', line[4:].strip(), 3))
              elif line.startswith('## '):
                  elements.append(('heading', line[3:].strip(), 2))
              elif line.startswith('# '):
                  elements.append(('heading', line[2:].strip(), 1))
              elif line.strip().startswith('- '):
                  elements.append(('bullet', line.strip()[2:], 0))
              elif re.match(r'^\d+\. ', line.strip()):
                  text = re.sub(r'^\d+\. ', '', line.strip())
                  elements.append(('numbered', text, 0))
              else:
                  # ë³¼ë“œ ì œê±°
                  clean = re.sub(r'\*\*(.*?)\*\*', r'\1', line)
                  # ì½”ë“œ ì œê±°
                  clean = re.sub(r'`([^`]+)`', r'\1', clean)
                  elements.append(('text', clean, 0))

          # Google Docsì— í…ìŠ¤íŠ¸ ì‚½ì… í›„ ìŠ¤íƒ€ì¼ ì ìš©
          current_index = 1

          for elem_type, text, level in elements:
              if elem_type == 'empty':
                  requests.append({
                      'insertText': {
                          'location': {'index': current_index},
                          'text': '\n'
                      }
                  })
                  current_index += 1

              elif elem_type == 'heading':
                  full_text = text + '\n'
                  start = current_index

                  requests.append({
                      'insertText': {
                          'location': {'index': current_index},
                          'text': full_text
                      }
                  })

                  # í—¤ë”© ìŠ¤íƒ€ì¼ ì ìš©
                  style_type = f'HEADING_{level}'
                  requests.append({
                      'updateParagraphStyle': {
                          'range': {'startIndex': start, 'endIndex': start + len(full_text) - 1},
                          'paragraphStyle': {'namedStyleType': style_type},
                          'fields': 'namedStyleType'
                      }
                  })
                  current_index += len(full_text)

              elif elem_type in ['bullet', 'numbered']:
                  full_text = text + '\n'
                  start = current_index

                  requests.append({
                      'insertText': {
                          'location': {'index': current_index},
                          'text': full_text
                      }
                  })

                  # ë¦¬ìŠ¤íŠ¸ ìŠ¤íƒ€ì¼ ì ìš©
                  preset = 'BULLET_DISC_CIRCLE_SQUARE' if elem_type == 'bullet' else 'NUMBERED_DECIMAL_ALPHA_ROMAN'
                  requests.append({
                      'createParagraphBullets': {
                          'range': {'startIndex': start, 'endIndex': start + len(full_text) - 1},
                          'bulletPreset': preset
                      }
                  })
                  current_index += len(full_text)

              else:  # text
                  full_text = text + '\n'
                  requests.append({
                      'insertText': {
                          'location': {'index': current_index},
                          'text': full_text
                      }
                  })
                  current_index += len(full_text)

          # API í˜¸ì¶œ
          if requests:
              service.documents().batchUpdate(
                  documentId=document_id,
                  body={'requests': requests}
              ).execute()

          print(f"âœ… Google Docs ì—…ë°ì´íŠ¸ ì™„ë£Œ (í‘œì¤€ PRD í¬ë§·)!")
          print(f"ğŸ“„ Document ID: {document_id}")
          print(f"ğŸ”— https://docs.google.com/document/d/{document_id}/edit")
          EOF
