name: Update PRD in Google Docs

on:
  push:
    branches:
      - main
    paths:
      - 'PRODUCT_REQUIREMENTS.md'

jobs:
  update-google-docs:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: |
          pip install google-auth google-auth-oauthlib google-auth-httplib2 google-api-python-client

      - name: Update Google Docs
        env:
          GOOGLE_SERVICE_ACCOUNT_KEY: ${{ secrets.GOOGLE_SERVICE_ACCOUNT_KEY }}
          GOOGLE_DOCS_ID: ${{ secrets.GOOGLE_DOCS_ID }}
        run: |
          python3 << 'EOF'
          import os
          import json
          import re
          from google.oauth2 import service_account
          from googleapiclient.discovery import build

          # Service Account ì¸ì¦
          credentials_dict = json.loads(os.environ['GOOGLE_SERVICE_ACCOUNT_KEY'])
          credentials = service_account.Credentials.from_service_account_info(
              credentials_dict,
              scopes=['https://www.googleapis.com/auth/documents']
          )

          # Google Docs API í´ë¼ì´ì–¸íŠ¸
          service = build('docs', 'v1', credentials=credentials)
          document_id = os.environ['GOOGLE_DOCS_ID']

          # PRODUCT_REQUIREMENTS.md ì½ê¸°
          with open('PRODUCT_REQUIREMENTS.md', 'r', encoding='utf-8') as f:
              markdown_content = f.read()

          # ë§ˆí¬ë‹¤ìš´ ê¸°í˜¸ ì œê±°í•˜ì—¬ ê¹”ë”í•œ í…ìŠ¤íŠ¸ë¡œ ë³€í™˜
          clean_text = markdown_content

          # í—¤ë” ê¸°í˜¸ ì œê±° (###, ##, # â†’ ê·¸ëƒ¥ í…ìŠ¤íŠ¸)
          clean_text = re.sub(r'^### ', '', clean_text, flags=re.MULTILINE)
          clean_text = re.sub(r'^## ', '', clean_text, flags=re.MULTILINE)
          clean_text = re.sub(r'^# ', '', clean_text, flags=re.MULTILINE)

          # ë³¼ë“œ ê¸°í˜¸ ì œê±° (**text** â†’ text)
          clean_text = re.sub(r'\*\*(.*?)\*\*', r'\1', clean_text)

          # ë¦¬ìŠ¤íŠ¸ ë§ˆì»¤ ì œê±° (ë“¤ì—¬ì“°ê¸°ëŠ” ìœ ì§€)
          clean_text = re.sub(r'^(\s*)- ', r'\1â€¢ ', clean_text, flags=re.MULTILINE)
          clean_text = re.sub(r'^(\s*)\d+\. ', r'\1', clean_text, flags=re.MULTILINE)

          # ì½”ë“œ ë¸”ë¡ ê¸°í˜¸ ì œê±° (```ì™€ ` ì œê±°)
          clean_text = re.sub(r'```[\w]*\n', '', clean_text)
          clean_text = re.sub(r'```', '', clean_text)
          clean_text = re.sub(r'`([^`]+)`', r'\1', clean_text)

          # ê¸°ì¡´ ë¬¸ì„œ ë‚´ìš© ì‚­ì œ
          document = service.documents().get(documentId=document_id).execute()
          doc_content = document.get('body').get('content')
          end_index = 1
          if len(doc_content) > 1:
              last_element = doc_content[-1]
              if 'endIndex' in last_element:
                  end_index = last_element['endIndex'] - 1

          requests = []

          # ê¸°ì¡´ ë‚´ìš© ì‚­ì œ
          if end_index > 1:
              requests.append({
                  'deleteContentRange': {
                      'range': {'startIndex': 1, 'endIndex': end_index}
                  }
              })

          # ì •ë¦¬ëœ í…ìŠ¤íŠ¸ ì‚½ì…
          requests.append({
              'insertText': {
                  'location': {'index': 1},
                  'text': clean_text
              }
          })

          # API í˜¸ì¶œ
          service.documents().batchUpdate(
              documentId=document_id,
              body={'requests': requests}
          ).execute()

          print(f"âœ… Google Docs ì—…ë°ì´íŠ¸ ì™„ë£Œ (ê¹”ë”í•œ í…ìŠ¤íŠ¸)!")
          print(f"ğŸ“„ Document ID: {document_id}")
          print(f"ğŸ”— https://docs.google.com/document/d/{document_id}/edit")
          EOF
