name: Update PRD in Google Docs

on:
  push:
    branches:
      - main
    paths:
      - 'PRODUCT_REQUIREMENTS.md'

jobs:
  update-google-docs:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: |
          pip install google-auth google-auth-oauthlib google-auth-httplib2 google-api-python-client

      - name: Update Google Docs
        env:
          GOOGLE_SERVICE_ACCOUNT_KEY: ${{ secrets.GOOGLE_SERVICE_ACCOUNT_KEY }}
          GOOGLE_DOCS_ID: ${{ secrets.GOOGLE_DOCS_ID }}
        run: |
          python3 << 'EOF'
          import os
          import json
          from google.oauth2 import service_account
          from googleapiclient.discovery import build

          # Service Account Ïù∏Ï¶ù
          credentials_dict = json.loads(os.environ['GOOGLE_SERVICE_ACCOUNT_KEY'])
          credentials = service_account.Credentials.from_service_account_info(
              credentials_dict,
              scopes=['https://www.googleapis.com/auth/documents']
          )

          # Google Docs API ÌÅ¥ÎùºÏù¥Ïñ∏Ìä∏
          service = build('docs', 'v1', credentials=credentials)
          document_id = os.environ['GOOGLE_DOCS_ID']

          # PRODUCT_REQUIREMENTS.md ÏùΩÍ∏∞
          with open('PRODUCT_REQUIREMENTS.md', 'r', encoding='utf-8') as f:
              markdown_content = f.read()

          # Í∏∞Ï°¥ Î¨∏ÏÑú ÎÇ¥Ïö© Í∞ÄÏ†∏Ïò§Í∏∞
          document = service.documents().get(documentId=document_id).execute()
          doc_content = document.get('body').get('content')

          # Î¨∏ÏÑúÏùò Ï†ÑÏ≤¥ ÌÖçÏä§Ìä∏ Í∏∏Ïù¥ Í≥ÑÏÇ∞ (Ï≤´ Î≤àÏß∏ ÏöîÏÜå Ï†úÏô∏)
          end_index = 1
          if len(doc_content) > 1:
              last_element = doc_content[-1]
              if 'endIndex' in last_element:
                  end_index = last_element['endIndex'] - 1

          # Î¨∏ÏÑú ÎÇ¥Ïö© Ï†ÑÏ≤¥ ÏÇ≠Ï†ú ÌõÑ ÏÉà ÎÇ¥Ïö© ÏÇΩÏûÖ
          requests = []

          # 1. Í∏∞Ï°¥ ÎÇ¥Ïö© ÏÇ≠Ï†ú (Ïù∏Îç±Ïä§ 1Î∂ÄÌÑ∞ ÎÅùÍπåÏßÄ)
          if end_index > 1:
              requests.append({
                  'deleteContentRange': {
                      'range': {
                          'startIndex': 1,
                          'endIndex': end_index
                      }
                  }
              })

          # 2. ÏÉà ÎÇ¥Ïö© ÏÇΩÏûÖ
          requests.append({
              'insertText': {
                  'location': {
                      'index': 1
                  },
                  'text': markdown_content
              }
          })

          # API Ìò∏Ï∂ú
          result = service.documents().batchUpdate(
              documentId=document_id,
              body={'requests': requests}
          ).execute()

          print(f"‚úÖ Google Docs ÏóÖÎç∞Ïù¥Ìä∏ ÏôÑÎ£å!")
          print(f"üìÑ Document ID: {document_id}")
          print(f"üîó https://docs.google.com/document/d/{document_id}/edit")
          EOF
