name: Update PRD in Google Docs

on:
  push:
    branches:
      - main
    paths:
      - 'PRODUCT_REQUIREMENTS.md'

jobs:
  update-google-docs:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: |
          pip install google-auth google-auth-oauthlib google-auth-httplib2 google-api-python-client

      - name: Update Google Docs
        env:
          GOOGLE_SERVICE_ACCOUNT_KEY: ${{ secrets.GOOGLE_SERVICE_ACCOUNT_KEY }}
          GOOGLE_DOCS_ID: ${{ secrets.GOOGLE_DOCS_ID }}
        run: |
          python3 << 'EOF'
          import os
          import json
          import re
          from google.oauth2 import service_account
          from googleapiclient.discovery import build

          # Service Account ì¸ì¦
          credentials_dict = json.loads(os.environ['GOOGLE_SERVICE_ACCOUNT_KEY'])
          credentials = service_account.Credentials.from_service_account_info(
              credentials_dict,
              scopes=['https://www.googleapis.com/auth/documents']
          )

          # Google Docs API í´ë¼ì´ì–¸íŠ¸
          service = build('docs', 'v1', credentials=credentials)
          document_id = os.environ['GOOGLE_DOCS_ID']

          # PRODUCT_REQUIREMENTS.md ì½ê¸°
          with open('PRODUCT_REQUIREMENTS.md', 'r', encoding='utf-8') as f:
              markdown_content = f.read()

          # ê¸°ì¡´ ë¬¸ì„œ ë‚´ìš© ì‚­ì œ
          document = service.documents().get(documentId=document_id).execute()
          doc_content = document.get('body').get('content')
          end_index = 1
          if len(doc_content) > 1:
              last_element = doc_content[-1]
              if 'endIndex' in last_element:
                  end_index = last_element['endIndex'] - 1

          requests = []
          if end_index > 1:
              requests.append({
                  'deleteContentRange': {
                      'range': {'startIndex': 1, 'endIndex': end_index}
                  }
              })

          # ë§ˆí¬ë‹¤ìš´ íŒŒì‹± ë° í¬ë§·íŒ…
          lines = markdown_content.split('\n')
          current_index = 1

          for line in lines:
              # ë¹ˆ ì¤„
              if not line.strip():
                  requests.append({
                      'insertText': {'location': {'index': current_index}, 'text': '\n'}
                  })
                  current_index += 1
                  continue

              # í—¤ë” íŒŒì‹±
              if line.startswith('# '):
                  text = line[2:] + '\n'
                  requests.append({'insertText': {'location': {'index': current_index}, 'text': text}})
                  requests.append({
                      'updateParagraphStyle': {
                          'range': {'startIndex': current_index, 'endIndex': current_index + len(text) - 1},
                          'paragraphStyle': {'namedStyleType': 'HEADING_1'},
                          'fields': 'namedStyleType'
                      }
                  })
                  current_index += len(text)

              elif line.startswith('## '):
                  text = line[3:] + '\n'
                  requests.append({'insertText': {'location': {'index': current_index}, 'text': text}})
                  requests.append({
                      'updateParagraphStyle': {
                          'range': {'startIndex': current_index, 'endIndex': current_index + len(text) - 1},
                          'paragraphStyle': {'namedStyleType': 'HEADING_2'},
                          'fields': 'namedStyleType'
                      }
                  })
                  current_index += len(text)

              elif line.startswith('### '):
                  text = line[4:] + '\n'
                  requests.append({'insertText': {'location': {'index': current_index}, 'text': text}})
                  requests.append({
                      'updateParagraphStyle': {
                          'range': {'startIndex': current_index, 'endIndex': current_index + len(text) - 1},
                          'paragraphStyle': {'namedStyleType': 'HEADING_3'},
                          'fields': 'namedStyleType'
                      }
                  })
                  current_index += len(text)

              # ë¦¬ìŠ¤íŠ¸ (- ë˜ëŠ” ìˆ«ì.)
              elif line.strip().startswith('- ') or re.match(r'^\d+\. ', line.strip()):
                  # ë¦¬ìŠ¤íŠ¸ ë§ˆì»¤ ì œê±°
                  if line.strip().startswith('- '):
                      clean_text = line.strip()[2:] + '\n'
                      is_bullet = True
                  else:
                      clean_text = re.sub(r'^\d+\. ', '', line.strip()) + '\n'
                      is_bullet = False

                  start_idx = current_index
                  requests.append({'insertText': {'location': {'index': current_index}, 'text': clean_text}})
                  current_index += len(clean_text)

                  # ë¦¬ìŠ¤íŠ¸ ìŠ¤íƒ€ì¼ ì ìš©
                  requests.append({
                      'createParagraphBullets': {
                          'range': {'startIndex': start_idx, 'endIndex': current_index - 1},
                          'bulletPreset': 'BULLET_DISC_CIRCLE_SQUARE' if is_bullet else 'NUMBERED_DECIMAL_ALPHA_ROMAN'
                      }
                  })

              # ì¼ë°˜ í…ìŠ¤íŠ¸ (ë³¼ë“œ ì²˜ë¦¬ í¬í•¨)
              else:
                  # **ë³¼ë“œ** ë§ˆí¬ë‹¤ìš´ ì²˜ë¦¬
                  text = line + '\n'
                  clean_text = re.sub(r'\*\*(.*?)\*\*', r'\1', text)

                  start_idx = current_index
                  requests.append({'insertText': {'location': {'index': current_index}, 'text': clean_text}})

                  # ë³¼ë“œ ì˜ì—­ ì°¾ì•„ì„œ ìŠ¤íƒ€ì¼ ì ìš©
                  bold_matches = list(re.finditer(r'\*\*(.*?)\*\*', text))
                  offset = 0
                  for match in bold_matches:
                      bold_start = start_idx + match.start() - offset
                      bold_end = start_idx + match.end() - offset - 4  # ** 4ê¸€ì ì œê±°
                      requests.append({
                          'updateTextStyle': {
                              'range': {'startIndex': bold_start, 'endIndex': bold_end},
                              'textStyle': {'bold': True},
                              'fields': 'bold'
                          }
                      })
                      offset += 4  # ** ì œê±°ëœ ë§Œí¼

                  current_index += len(clean_text)

          # API í˜¸ì¶œ
          if requests:
              service.documents().batchUpdate(
                  documentId=document_id,
                  body={'requests': requests}
              ).execute()

          print(f"âœ… Google Docs ì—…ë°ì´íŠ¸ ì™„ë£Œ (í¬ë§·íŒ… ì ìš©)!")
          print(f"ğŸ“„ Document ID: {document_id}")
          print(f"ğŸ”— https://docs.google.com/document/d/{document_id}/edit")
          EOF
