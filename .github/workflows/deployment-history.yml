name: Record Deployment History

on:
  push:
    branches:
      - main

jobs:
  record-deployment:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 2  # ìµœê·¼ 2ê°œ ì»¤ë°‹ ê°€ì ¸ì˜¤ê¸° (ë³€ê²½ì‚¬í•­ ë¹„êµìš©)

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: |
          pip install google-auth google-auth-oauthlib google-auth-httplib2 google-api-python-client

      - name: Record Deployment to Google Sheets
        env:
          GOOGLE_SERVICE_ACCOUNT_KEY: ${{ secrets.GOOGLE_SERVICE_ACCOUNT_KEY }}
          GOOGLE_SHEETS_ID: ${{ secrets.GOOGLE_SHEETS_ID }}
          GITHUB_SHA: ${{ github.sha }}
          GITHUB_ACTOR: ${{ github.actor }}
          GITHUB_REPOSITORY: ${{ github.repository }}
        run: |
          python3 << 'EOF'
          import os
          import json
          import subprocess
          from datetime import datetime, timezone, timedelta
          from google.oauth2 import service_account
          from googleapiclient.discovery import build

          # Service Account ì¸ì¦
          credentials_dict = json.loads(os.environ['GOOGLE_SERVICE_ACCOUNT_KEY'])
          credentials = service_account.Credentials.from_service_account_info(
              credentials_dict,
              scopes=['https://www.googleapis.com/auth/spreadsheets']
          )

          # Google Sheets API í´ë¼ì´ì–¸íŠ¸
          service = build('sheets', 'v4', credentials=credentials)
          spreadsheet_id = os.environ['GOOGLE_SHEETS_ID']

          # Git ì •ë³´ ê°€ì ¸ì˜¤ê¸°
          commit_sha = os.environ['GITHUB_SHA'][:7]
          commit_message = subprocess.check_output(
              ['git', 'log', '-1', '--pretty=%s'],
              text=True
          ).strip()
          author = os.environ['GITHUB_ACTOR']
          repository = os.environ['GITHUB_REPOSITORY']

          # ë³€ê²½ëœ íŒŒì¼ ëª©ë¡ ê°€ì ¸ì˜¤ê¸°
          changed_files = subprocess.check_output(
              ['git', 'diff', '--name-only', 'HEAD~1', 'HEAD'],
              text=True
          ).strip().split('\n')

          # Frontend/Backend ë³€ê²½ ê°ì§€
          frontend_changed = any(
              f.startswith('src/') or
              f.startswith('public/') or
              (f == 'package.json' and not f.startswith('server/'))
              for f in changed_files
          )

          backend_changed = any(
              f.startswith('server/') or
              f == 'server/package.json'
              for f in changed_files
          )

          # í˜„ì¬ ì‹œê°„ (KST = UTC+9)
          kst = timezone(timedelta(hours=9))
          now = datetime.now(kst)
          date_str = now.strftime('%Y-%m-%d')
          time_str = now.strftime('%H:%M:%S')

          # Compare URL
          compare_url = f"https://github.com/{repository}/commit/{os.environ['GITHUB_SHA']}"

          # ë³€ê²½ëœ íŒŒì¼ ëª©ë¡ (ìµœëŒ€ 5ê°œë§Œ í‘œì‹œ)
          files_display = ', '.join(changed_files[:5])
          if len(changed_files) > 5:
              files_display += f' (+{len(changed_files) - 5} more)'

          # Google Sheetsì— ê¸°ë¡
          def append_to_sheet(sheet_name, platform):
              values = [[
                  date_str,
                  time_str,
                  commit_sha,
                  commit_message,
                  author,
                  files_display,
                  compare_url,
                  'Deployed',
                  platform
              ]]

              body = {'values': values}
              result = service.spreadsheets().values().append(
                  spreadsheetId=spreadsheet_id,
                  range=f'{sheet_name}!A:I',
                  valueInputOption='RAW',
                  body=body
              ).execute()

              print(f"âœ… {sheet_name} ê¸°ë¡ ì™„ë£Œ!")
              return result

          # Frontend ë°°í¬ ê¸°ë¡
          if frontend_changed:
              append_to_sheet('Frontend Deployments', 'Vercel')
              print(f"ğŸ“¦ Frontend ë°°í¬ ê¸°ë¡ë¨")

          # Backend ë°°í¬ ê¸°ë¡
          if backend_changed:
              append_to_sheet('Backend Deployments', 'Render')
              print(f"ğŸš€ Backend ë°°í¬ ê¸°ë¡ë¨")

          if not frontend_changed and not backend_changed:
              print(f"â„¹ï¸ Frontend/Backend ì½”ë“œ ë³€ê²½ ì—†ìŒ (ë¬¸ì„œ ì—…ë°ì´íŠ¸ ë“±)")

          print(f"\nğŸ“Š ìŠ¤í”„ë ˆë“œì‹œíŠ¸: https://docs.google.com/spreadsheets/d/{spreadsheet_id}/edit")
          EOF
